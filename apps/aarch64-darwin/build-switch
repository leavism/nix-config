#!/bin/sh -e

# Colors for output
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
RED='\033[1;31m'
NC='\033[0m'

# Get current hostname
HOSTNAME=$(hostname -s)
export NIXPKGS_ALLOW_UNFREE=1

# Determine system type and configuration paths
if [ "$(uname)" = "Darwin" ]; then
    SYSTEM_TYPE="aarch64-darwin"
    CONFIG_PATH="darwinConfigurations"
    HOST_DIR="hosts/darwin"
    DEFAULT_CONFIG="${HOST_DIR}/default.nix"
    SPECIFIC_CONFIG="${HOST_DIR}/${HOSTNAME}.nix"
    REBUILD_CMD="darwin-rebuild"
else
    SYSTEM_TYPE="x86_64-linux"
    CONFIG_PATH="nixosConfigurations"
    HOST_DIR="hosts/nixos"
    DEFAULT_CONFIG="${HOST_DIR}/default.nix"
    SPECIFIC_CONFIG="${HOST_DIR}/${HOSTNAME}.nix"
    REBUILD_CMD="nixos-rebuild"
fi

# Determine which configuration to use
if [ -f "$SPECIFIC_CONFIG" ]; then
    echo "${BLUE}Found specific configuration for hostname '${HOSTNAME}'${NC}"
    echo "${BLUE}Using configuration: ${SPECIFIC_CONFIG}${NC}"
    CONFIG_NAME="${HOSTNAME}"
else
    echo "${BLUE}No specific configuration found for hostname '${HOSTNAME}'${NC}"
    echo "${BLUE}Using default configuration: ${DEFAULT_CONFIG}${NC}"
    CONFIG_NAME="default"
fi

FLAKE_SYSTEM="${CONFIG_PATH}.${CONFIG_NAME}.system"

echo "${YELLOW}Starting build...${NC}"

# Build the configuration
nix --extra-experimental-features 'nix-command flakes' build ".#${FLAKE_SYSTEM}" "$@"

echo "${YELLOW}Switching to new generation...${NC}"

if [ "$(uname)" = "Darwin" ]; then
    ./result/sw/bin/darwin-rebuild switch --flake ".#${CONFIG_NAME}" "$@"
else
    ./result/bin/switch-to-configuration switch
fi

echo "${YELLOW}Cleaning up...${NC}"
[ -L ./result ] && unlink ./result

echo "${GREEN}Switch to new generation complete!${NC}"
